<div class="edit-dialog">
  <h2 mat-dialog-title>{{ isCreateMode ? 'Add line' : 'Edit Line: ' + getLineDisplayName() + (getLineFieldName() ? ' (' + getLineFieldName() + ')' : '') }}</h2>

  <mat-dialog-content>
    @if (loadingLine()) {
      <div class="loading-line"><mat-spinner diameter="32"></mat-spinner><span>Loading line...</span></div>
    } @else {
    <form [formGroup]="editForm" class="edit-form">
      <!-- Name (required for create) -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Name</mat-label>
        <input matInput formControlName="name" placeholder="Line name" required>
        @if (isCreateMode) {
          <mat-error>Name is required</mat-error>
        }
      </mat-form-field>

      <!-- Field Name -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Field Name</mat-label>
        <input matInput formControlName="field_name" placeholder="Field name">
      </mat-form-field>

      <!-- Sub-category (when category has sub-categories) -->
      @if (subCategories().length > 0) {
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Sub-category</mat-label>
          <mat-select formControlName="sub_category_id">
            <mat-option [value]="null">Uncategorized</mat-option>
            @for (sc of subCategories(); track sc.id) {
              <mat-option [value]="sc.id">{{ sc.name }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      }

      <!-- Default, Reason -->
<!--      <mat-form-field appearance="outline" class="full-width">-->
<!--        <mat-label>Default</mat-label>-->
<!--        <input matInput formControlName="default" placeholder="Default value">-->
<!--      </mat-form-field>-->

      <!-- Seq No, Customer settings, No of chars -->
<!--      <mat-form-field appearance="outline" class="full-width">-->
<!--        <mat-label>Seq No</mat-label>-->
<!--        <input matInput type="number" formControlName="seq_no" placeholder="Sequence number">-->
<!--      </mat-form-field>-->
<!--      <mat-form-field appearance="outline" class="full-width">-->
<!--        <mat-label>Customer settings</mat-label>-->
<!--        <input matInput formControlName="customer_settings" placeholder="Customer settings">-->
<!--      </mat-form-field>-->
<!--      <mat-form-field appearance="outline" class="full-width">-->
<!--        <mat-label>No of chars</mat-label>-->
<!--        <input matInput formControlName="no_of_chars" placeholder="No of chars">-->
<!--      </mat-form-field>-->

      <!-- Table Name Autocomplete -->
      <div class="form-field-with-action">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Table Name</mat-label>
          <input
            #tableInput
            matInput
            formControlName="table_name"
            [matAutocomplete]="tableAuto"
            placeholder="Type to search tables..."
            [disabled]="loadingTables()"
            (focus)="onTableInputFocus()"
            (blur)="onTableInputBlur()"
            (input)="onTableInputChange()">
          <mat-autocomplete
            #tableAuto="matAutocomplete"
            [displayWith]="displayTableName"
            (optionSelected)="onTableSelected($event.option.value)"
            class="compact-autocomplete"
            [class.hide-dropdown]="!tableDropdownOpen">
            @if (loadingTables()) {
              <mat-option disabled>
                <mat-spinner diameter="20"></mat-spinner>
                Loading tables...
              </mat-option>
            } @else if (tableDropdownOpen) {
              @for (table of filteredTables$ | async; track table.id) {
                <mat-option [value]="table" class="compact-option">
                  {{ table.name }} - {{ table.description }}
                </mat-option>
              }
            }
          </mat-autocomplete>
        </mat-form-field>
        <button
          mat-icon-button
          type="button"
          (click)="onClearTable()"
          [disabled]="!isClearTableEnabled()"
          class="clear-button"
          matTooltip="Clear table and column">
          <mat-icon>clear</mat-icon>
        </button>
      </div>

      <!-- Column Name Autocomplete -->
      <div class="form-field-with-action">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Column Name</mat-label>
          <input
            #columnInput
            matInput
            formControlName="column_name"
            [matAutocomplete]="columnAuto"
            placeholder="Type to search columns..."
            [disabled]="editForm.get('column_name')?.disabled || false"
            (focus)="onColumnInputFocus()"
            (blur)="onColumnInputBlur()"
            (input)="onColumnInputChange()">
          <mat-autocomplete
            #columnAuto="matAutocomplete"
            [displayWith]="displayColumnName"
            (optionSelected)="onColumnSelected($event.option.value)"
            class="compact-autocomplete"
            [class.hide-dropdown]="!columnDropdownOpen">
            @if (loadingColumns()) {
              <mat-option disabled>
                <mat-spinner diameter="20"></mat-spinner>
                Loading columns...
              </mat-option>
            } @else if (columns().length === 0 && !loadingColumns()) {
              <mat-option disabled>
                Please select a table first
              </mat-option>
            } @else if (columnDropdownOpen) {
              @for (column of filteredColumns$ | async; track column.id) {
                <mat-option [value]="column" class="compact-option">
                  <div class="column-option">
                    <div class="column-name">{{ column.name }}</div>
                    @if (column.comment && column.comment !== 'None' && column.comment.trim()) {
                      <div class="column-comment">{{ column.comment }}</div>
                    }
                    <div class="column-type">({{ column.type }})</div>
                  </div>
                </mat-option>
              }
            }
          </mat-autocomplete>
        </mat-form-field>
        <button
          mat-icon-button
          type="button"
          (click)="onClearColumn()"
          [disabled]="!isClearColumnEnabled()"
          class="clear-button"
          matTooltip="Clear column">
          <mat-icon>clear</mat-icon>
        </button>
      </div>

      <div class="form-field-with-action">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Reason</mat-label>
          <input matInput formControlName="reason" placeholder="Reason">
        </mat-form-field>
        <button
          mat-icon-button
          type="button"
          (click)="onFetchReasonFromColumn()"
          [disabled]="!isFetchReasonEnabled() || loadingReason()"
          class="clear-button"
          matTooltip="Fill Reason from column comment">
          @if (loadingReason()) {
            <mat-spinner diameter="24"></mat-spinner>
          } @else {
            <mat-icon>description</mat-icon>
          }
        </button>
      </div>

      <!-- Comment Field -->
<!--      <mat-form-field appearance="outline" class="full-width">-->
<!--        <mat-label>Comment</mat-label>-->
<!--        <textarea-->
<!--          matInput-->
<!--          formControlName="comment"-->
<!--          placeholder="Enter comment..."-->
<!--          rows="3"-->
<!--          maxlength="500">-->
<!--        </textarea>-->
<!--        <mat-hint align="end">{{ editForm.get('comment')?.value?.length || 0 }}/500</mat-hint>-->
<!--      </mat-form-field>-->

      <!-- Exclude and key field checkboxes -->
      <div class="exclude-section">
        <mat-checkbox
          formControlName="exclude"
          (change)="onExcludeToggle()"
          class="exclude-checkbox">
          Exclude from percentage calculations
        </mat-checkbox>
        <mat-hint class="exclude-hint">
          When checked, this line will be excluded from all percentage calculations and appear grayed out in the list.
        </mat-hint>
      </div>
      <div class="key-fields-section">
        <mat-checkbox formControlName="iskeyfield" class="key-checkbox">Key field</mat-checkbox>
        <mat-checkbox formControlName="isfkfield" class="key-checkbox">Foreign key field</mat-checkbox>
      </div>

      <!-- Auto-match button -->
      <div class="auto-match-section">
        <button
          mat-stroked-button
          type="button"
          (click)="onAutoMatchColumn()"
          [disabled]="!isAutoMatchEnabled()"
          class="auto-match-button">
          <mat-icon>search</mat-icon>
          Auto-match Column
        </button>
        <mat-hint class="auto-match-hint">
          @if (!isAutoMatchEnabled()) {
            @if (!editForm.get('table_name')?.value) {
              Select a table first
            } @else if (!getFieldNameForMatch()) {
              No field name available
            } @else if (loadingColumns()) {
              Loading columns...
            } @else {
              No columns available
            }
          } @else {
            Match column with field name: {{ getLineFieldName() }}
          }
        </mat-hint>
      </div>

      <!-- Search button -->
      <div class="search-section">
        <button
          mat-stroked-button
          type="button"
          (click)="onSearchColumns()"
          [disabled]="!isSearchEnabled()"
          class="search-button">
          <mat-icon>search</mat-icon>
          Search
        </button>
        <mat-hint class="search-hint">
          @if (!isSearchEnabled()) {
            No field name available to search
          } @else {
            Search for columns matching field name across all tables: {{ getLineFieldName() }}
          }
        </mat-hint>
      </div>

      <!-- Search Results -->
      @if (searchResults().length > 0) {
        <div class="search-results-section">
          <div class="search-results-header">
            <h4>Search Results</h4>
          </div>
          <div class="search-results-list">
            @for (result of searchResults(); track result.column_id) {
              <div
                class="search-result-item"
                (click)="onSearchResultSelected(result)"
                [class.selected]="selectedSearchResult()?.column_id === result.column_id">
                <div class="result-header">
                  <span class="column-name">{{ result.column_name }}</span>
                  <span class="match-type" [class.exact]="result.match_type === 'exact'">
                    {{ result.match_type }}
                  </span>
                </div>
                <div class="table-name">{{ result.table_name }}</div>
              </div>
            }
          </div>
        </div>
      }

    </form>
    }
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button #cancelButton mat-button (click)="onCancel()">Cancel</button>
    <button
      mat-raised-button
      color="primary"
      (click)="onSave()">
      Save
    </button>
  </mat-dialog-actions>
</div>
