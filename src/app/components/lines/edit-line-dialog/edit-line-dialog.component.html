<div class="edit-dialog">
  <h2 mat-dialog-title>Edit Line: {{ getLineDisplayName() }} ({{ getLineFieldName()  }})</h2>

  <mat-dialog-content>
    <form [formGroup]="editForm" class="edit-form">
      <!-- Table Name Autocomplete -->
      <div class="form-field-with-action">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Table Name</mat-label>
          <input
            #tableInput
            matInput
            formControlName="table_name"
            [matAutocomplete]="tableAuto"
            placeholder="Type to search tables..."
            [disabled]="loadingTables()"
            (focus)="onTableInputFocus()"
            (blur)="onTableInputBlur()"
            (input)="onTableInputChange()">
          <mat-autocomplete
            #tableAuto="matAutocomplete"
            [displayWith]="displayTableName"
            (optionSelected)="onTableSelected($event.option.value)"
            class="compact-autocomplete"
            [class.hide-dropdown]="!tableDropdownOpen">
            @if (loadingTables()) {
              <mat-option disabled>
                <mat-spinner diameter="20"></mat-spinner>
                Loading tables...
              </mat-option>
            } @else if (tableDropdownOpen) {
              @for (table of filteredTables$ | async; track table.id) {
                <mat-option [value]="table" class="compact-option">
                  {{ table.name }} - {{ table.description }}
                </mat-option>
              }
            }
          </mat-autocomplete>
        </mat-form-field>
        <button
          mat-icon-button
          type="button"
          (click)="onClearTable()"
          [disabled]="!isClearTableEnabled()"
          class="clear-button"
          matTooltip="Clear table and column">
          <mat-icon>clear</mat-icon>
        </button>
      </div>

      <!-- Column Name Autocomplete -->
      <div class="form-field-with-action">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Column Name</mat-label>
          <input
            #columnInput
            matInput
            formControlName="column_name"
            [matAutocomplete]="columnAuto"
            placeholder="Type to search columns..."
            [disabled]="editForm.get('column_name')?.disabled || false"
            (focus)="onColumnInputFocus()"
            (blur)="onColumnInputBlur()"
            (input)="onColumnInputChange()">
          <mat-autocomplete
            #columnAuto="matAutocomplete"
            [displayWith]="displayColumnName"
            (optionSelected)="onColumnSelected($event.option.value)"
            class="compact-autocomplete"
            [class.hide-dropdown]="!columnDropdownOpen">
            @if (loadingColumns()) {
              <mat-option disabled>
                <mat-spinner diameter="20"></mat-spinner>
                Loading columns...
              </mat-option>
            } @else if (columns().length === 0 && !loadingColumns()) {
              <mat-option disabled>
                Please select a table first
              </mat-option>
            } @else if (columnDropdownOpen) {
              @for (column of filteredColumns$ | async; track column.id) {
                <mat-option [value]="column" class="compact-option">
                  <div class="column-option">
                    <div class="column-name">{{ column.name }}</div>
                    @if (column.comment && column.comment !== 'None' && column.comment.trim()) {
                      <div class="column-comment">{{ column.comment }}</div>
                    }
                    <div class="column-type">({{ column.type }})</div>
                  </div>
                </mat-option>
              }
            }
          </mat-autocomplete>
        </mat-form-field>
        <button
          mat-icon-button
          type="button"
          (click)="onClearColumn()"
          [disabled]="!isClearColumnEnabled()"
          class="clear-button"
          matTooltip="Clear column">
          <mat-icon>clear</mat-icon>
        </button>
      </div>

      <!-- Comment Field -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Comment</mat-label>
        <textarea
          matInput
          formControlName="comment"
          placeholder="Enter comment..."
          rows="3"
          maxlength="500">
        </textarea>
        <mat-hint align="end">{{ editForm.get('comment')?.value?.length || 0 }}/500</mat-hint>
      </mat-form-field>

      <!-- Auto-match button -->
      <div class="auto-match-section">
        <button
          mat-stroked-button
          type="button"
          (click)="onAutoMatchColumn()"
          [disabled]="!isAutoMatchEnabled()"
          class="auto-match-button">
          <mat-icon>search</mat-icon>
          Auto-match Column
        </button>
        <mat-hint class="auto-match-hint">
          @if (!isAutoMatchEnabled()) {
            @if (!editForm.get('table_name')?.value) {
              Select a table first
            } @else if (!data.line.field_name || !data.line.field_name.trim()) {
              No field name available
            } @else if (loadingColumns()) {
              Loading columns...
            } @else {
              No columns available
            }
          } @else {
            Match column with field name: {{ data.line.field_name }}
          }
        </mat-hint>
      </div>

      <!-- Search button -->
      <div class="search-section">
        <button
          mat-stroked-button
          type="button"
          (click)="onSearchColumns()"
          [disabled]="!isSearchEnabled()"
          class="search-button">
          <mat-icon>search</mat-icon>
          Search
        </button>
        <mat-hint class="search-hint">
          @if (!isSearchEnabled()) {
            No field name available to search
          } @else {
            Search for columns matching field name across all tables: {{ data.line.field_name }}
          }
        </mat-hint>
      </div>

      <!-- Search Results -->
      @if (searchResults().length > 0) {
        <div class="search-results-section">
          <div class="search-results-header">
            <h4>Search Results</h4>
          </div>
          <div class="search-results-list">
            @for (result of searchResults(); track result.column_id) {
              <div
                class="search-result-item"
                (click)="onSearchResultSelected(result)"
                [class.selected]="selectedSearchResult()?.column_id === result.column_id">
                <div class="result-header">
                  <span class="column-name">{{ result.column_name }}</span>
                  <span class="match-type" [class.exact]="result.match_type === 'exact'">
                    {{ result.match_type }}
                  </span>
                </div>
                <div class="table-name">{{ result.table_name }}</div>
              </div>
            }
          </div>
        </div>
      }

    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button #cancelButton mat-button (click)="onCancel()">Cancel</button>
    <button
      mat-raised-button
      color="primary"
      (click)="onSave()">
      Save
    </button>
  </mat-dialog-actions>
</div>
