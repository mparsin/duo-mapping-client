<div class="lines-container">
  @if (showToolbar) {
    <mat-toolbar class="lines-toolbar">
      <button mat-icon-button (click)="goBack()" aria-label="Go back">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <span class="toolbar-title">
        Lines for {{ categoryName || 'Category' }}
      </span>
      <span class="spacer"></span>
      <button
        mat-icon-button
        (click)="toggleGroupBySubCategory()"
        [disabled]="loading()"
        [color]="groupBySubCategory() ? 'primary' : ''"
        aria-label="Toggle group by sub-category">
        <mat-icon>{{ groupBySubCategory() ? 'group_work' : 'view_list' }}</mat-icon>
      </button>
      <button
        mat-icon-button
        (click)="refreshLines()"
        [disabled]="loading()"
        aria-label="Refresh">
        <mat-icon>refresh</mat-icon>
      </button>
    </mat-toolbar>
  }

  <div class="content">
    @if (loading()) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
        <p>Loading lines...</p>
      </div>
    } @else if (error()) {
      <div class="error-container">
        <mat-icon color="warn">error</mat-icon>
        <p>{{ error() }}</p>
        <button mat-raised-button color="primary" (click)="refreshLines()">
          Try Again
        </button>
      </div>
    } @else if (lines().length === 0) {
      <div class="empty-container">
        <mat-icon>table_chart</mat-icon>
        <p>No lines found for this category</p>
        <button mat-raised-button color="primary" (click)="refreshLines()">
          Refresh
        </button>
      </div>
    } @else {
      <!-- Bulk Update Section -->
      @if (linesWithoutTable().length > 0 || linesWithoutColumn().length > 0 || linesWithTable().length > 0 || linesWithColumn().length > 0) {
        <mat-card class="bulk-update-card">
          <mat-card-header>
            <mat-card-title>
              <div class="title-left">
                <mat-icon>batch_prediction</mat-icon>
                <span>Bulk Update Commands</span>
                <!-- Status icon for mapping completeness -->
                <mat-icon 
                  class="mapping-status-icon"
                  [class.complete]="allLinesHaveCompleteMappings()"
                  [class.incomplete]="!allLinesHaveCompleteMappings()"
                  [title]="allLinesHaveCompleteMappings() ? 'All lines have complete table and column mappings' : 'Some lines are missing table or column mappings'">
                  {{ allLinesHaveCompleteMappings() ? 'check_circle' : 'warning' }}
                </mat-icon>
                <button
                  mat-icon-button
                  (click)="toggleCategoryBulkCommands()"
                  [class.expanded]="categoryBulkCommandsVisible()"
                  [class.has-bulk-commands]="hasCategoryBulkCommands()"
                  class="bulk-commands-toggle category-toggle"
                  [attr.aria-label]="categoryBulkCommandsVisible() ? 'Hide bulk commands' : 'Show bulk commands'">
                  <mat-icon>{{ categoryBulkCommandsVisible() ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>
              </div>

            </mat-card-title>
            <mat-card-subtitle>
              @if (linesWithoutTable().length > 0 && linesWithoutColumn().length > 0) {
                {{ linesWithoutTable().length }} line(s) without table, {{ linesWithoutColumn().length }} line(s) without column
              } @else if (linesWithoutTable().length > 0) {
                {{ linesWithoutTable().length }} line(s) without table assignment
              } @else if (linesWithoutColumn().length > 0) {
                {{ linesWithoutColumn().length }} line(s) without column assignment
              } @else if (linesWithTable().length > 0 || linesWithColumn().length > 0) {
                {{ linesWithTable().length }} line(s) with table, {{ linesWithColumn().length }} line(s) with column
              }
            </mat-card-subtitle>
          </mat-card-header>
          @if (categoryBulkCommandsVisible()) {
            <mat-card-content>
            <form [formGroup]="bulkUpdateForm" class="bulk-update-form">
              <div class="bulk-update-controls">
                <mat-form-field appearance="outline" class="table-selector">
                  <mat-label>Select Table</mat-label>
                  <input
                    matInput
                    formControlName="table_name"
                    [matAutocomplete]="tableAuto"
                    placeholder="Type to search tables..."
                    (focus)="onTableInputFocus()"
                    (blur)="onTableInputBlur()"
                    (input)="onTableInputChange()">
                  <mat-autocomplete
                    #tableAuto="matAutocomplete"
                    [displayWith]="displayTableName"
                    (optionSelected)="onTableSelected($event.option.value)"
                    class="compact-autocomplete"
                    [class.hide-dropdown]="!tableDropdownOpen">
                    @if (tableDropdownOpen) {
                      @for (table of filteredTables$ | async; track table.id) {
                        <mat-option [value]="table" class="compact-option">
                          {{ table.name }} - {{ table.description }}
                        </mat-option>
                      }
                    }
                  </mat-autocomplete>
                </mat-form-field>

                <button
                  mat-stroked-button
                  type="button"
                  (click)="onSuggestTables()"
                  [disabled]="loadingSuggestedTables()"
                  class="suggest-tables-button">
                  @if (loadingSuggestedTables()) {
                    <mat-spinner diameter="20"></mat-spinner>
                    Finding matches...
                  } @else {
                    <ng-container>
                      <mat-icon>recommend</mat-icon>
                      Suggest Tables
                    </ng-container>
                  }
                </button>

                <button
                  mat-raised-button
                  color="primary"
                  [disabled]="!selectedTableId() || bulkUpdating()"
                  (click)="bulkUpdateTableForLines()"
                  class="bulk-update-button">
                  @if (bulkUpdating()) {
                    <mat-spinner diameter="20"></mat-spinner>
                    Updating {{ bulkUpdateProgress().completed }}/{{ bulkUpdateProgress().total }}...
                  } @else {
                    <ng-container>
                      <mat-icon>update</mat-icon>
                      Set Table for All Lines
                    </ng-container>
                  }
                </button>
              </div>
            </form>

            <!-- Table Suggestions Results -->
            @if (showSuggestedTables() && suggestedTables().length > 0) {
              <div class="table-suggestions-section">
                <div class="suggestions-header">
                  <h4>Table Suggestions</h4>
                  <button mat-icon-button (click)="closeSuggestedTables()">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
                <div class="table-suggestions-list">
                  @for (match of suggestedTables(); track match.table_id) {
                    <div
                      class="table-suggestion-item"
                      (click)="onSelectSuggestedTable(match)">
                      <div class="suggestion-header">
                        <span class="table-name">{{ match.table_name }}</span>
                        <span class="match-count">{{ match.match_count }} of {{ match.total_columns }} matches</span>
                      </div>
                      <div class="matched-columns">
                        <span class="column-chip" *ngFor="let col of match.matched_columns.slice(0, 5)">
                          {{ col }}
                        </span>
                        @if (match.matched_columns.length > 5) {
                          <span class="more-columns">+{{ match.matched_columns.length - 5 }} more</span>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
            @if (bulkUpdating()) {
              <div class="bulk-update-progress">
                <mat-progress-bar
                  mode="determinate"
                  [value]="(bulkUpdateProgress().completed / bulkUpdateProgress().total) * 100">
                </mat-progress-bar>
                <p class="progress-text">
                  Updated {{ bulkUpdateProgress().completed }} of {{ bulkUpdateProgress().total }} lines
                  @if (bulkUpdateProgress().failed > 0) {
                    ({{ bulkUpdateProgress().failed }} failed)
                  }
                </p>
              </div>
            } @else {
              <p class="bulk-update-description">
                This will set the selected table for all {{ linesWithoutTable().length }} line(s) that currently don't have a table assigned. Column names will remain unchanged.
              </p>
            }

            <!-- Column Update Command -->
            @if (linesWithoutColumn().length > 0) {
              <mat-divider class="command-divider"></mat-divider>
              <div class="bulk-update-controls">
                <div class="command-info">
                  <mat-icon>view_column</mat-icon>
                  <span class="command-title">Update Columns by Field Name</span>
                </div>

                <button
                  mat-raised-button
                  color="accent"
                  [disabled]="bulkUpdatingColumns()"
                  (click)="bulkUpdateColumnsForLines()"
                  class="bulk-update-button">
                  @if (bulkUpdatingColumns()) {
                    <mat-spinner diameter="20"></mat-spinner>
                    Updating {{ columnBulkUpdateProgress().completed }}/{{ columnBulkUpdateProgress().total }}...
                  } @else {
                    <ng-container>
                      <mat-icon>auto_fix_high</mat-icon>
                      Match Columns by Field Name
                    </ng-container>
                  }
                </button>
              </div>

              @if (bulkUpdatingColumns()) {
                <div class="bulk-update-progress">
                  <mat-progress-bar
                    mode="determinate"
                    [value]="(columnBulkUpdateProgress().completed / columnBulkUpdateProgress().total) * 100">
                  </mat-progress-bar>
                  <p class="progress-text">
                    Updated {{ columnBulkUpdateProgress().completed }} of {{ columnBulkUpdateProgress().total }} columns
                    @if (columnBulkUpdateProgress().failed > 0) {
                      ({{ columnBulkUpdateProgress().failed }} failed)
                    }
                  </p>
                </div>
              } @else {
                <p class="bulk-update-description">
                  This will match field names to column names for all {{ linesWithoutColumn().length }} line(s) that have a table but no column assigned.
                </p>
              }
            }

            <!-- Clear Table Names Command -->
            @if (linesWithTable().length > 0) {
              <mat-divider class="command-divider"></mat-divider>
              <div class="bulk-update-controls">
                <div class="command-info">
                  <mat-icon>clear_all</mat-icon>
                  <span class="command-title">Clear All Table Names</span>
                </div>

                <button
                  mat-raised-button
                  color="warn"
                  [disabled]="bulkClearingTables()"
                  (click)="bulkClearTableNames()"
                  class="bulk-update-button">
                  @if (bulkClearingTables()) {
                    <mat-spinner diameter="20"></mat-spinner>
                    Clearing {{ tableClearProgress().completed }}/{{ tableClearProgress().total }}...
                  } @else {
                    <ng-container>
                      <mat-icon>delete_sweep</mat-icon>
                      Clear All Table Names
                    </ng-container>
                  }
                </button>
              </div>

              @if (bulkClearingTables()) {
                <div class="bulk-update-progress">
                  <mat-progress-bar
                    mode="determinate"
                    [value]="(tableClearProgress().completed / tableClearProgress().total) * 100">
                  </mat-progress-bar>
                  <p class="progress-text">
                    Cleared {{ tableClearProgress().completed }} of {{ tableClearProgress().total }} table names
                    @if (tableClearProgress().failed > 0) {
                      ({{ tableClearProgress().failed }} failed)
                    }
                  </p>
                </div>
              } @else {
                <p class="bulk-update-description">
                  This will clear table assignments for all {{ linesWithTable().length }} line(s) that currently have a table assigned.
                </p>
              }
            }

            <!-- Clear Column Names Command -->
            @if (linesWithColumn().length > 0) {
              <mat-divider class="command-divider"></mat-divider>
              <div class="bulk-update-controls">
                <div class="command-info">
                  <mat-icon>clear_all</mat-icon>
                  <span class="command-title">Clear All Column Names</span>
                </div>

                <button
                  mat-raised-button
                  color="warn"
                  [disabled]="bulkClearingColumns()"
                  (click)="bulkClearColumnNames()"
                  class="bulk-update-button">
                  @if (bulkClearingColumns()) {
                    <mat-spinner diameter="20"></mat-spinner>
                    Clearing {{ columnClearProgress().completed }}/{{ columnClearProgress().total }}...
                  } @else {
                    <ng-container>
                      <mat-icon>delete_sweep</mat-icon>
                      Clear All Column Names
                    </ng-container>
                  }
                </button>
              </div>

              @if (bulkClearingColumns()) {
                <div class="bulk-update-progress">
                  <mat-progress-bar
                    mode="determinate"
                    [value]="(columnClearProgress().completed / columnClearProgress().total) * 100">
                  </mat-progress-bar>
                  <p class="progress-text">
                    Cleared {{ columnClearProgress().completed }} of {{ columnClearProgress().total }} column names
                    @if (columnClearProgress().failed > 0) {
                      ({{ columnClearProgress().failed }} failed)
                    }
                  </p>
                </div>
              } @else {
                <p class="bulk-update-description">
                  This will clear column assignments for all {{ linesWithColumn().length }} line(s) that currently have a column assigned.
                </p>
              }
            }

            <!-- Category Exclude/Include Commands -->
            <mat-divider class="command-divider"></mat-divider>
            <div class="bulk-update-controls">
              <div class="command-info">
                <mat-icon>category</mat-icon>
                <span class="command-title">Category Actions</span>
                @if (isCategoryExcluded()) {
                  <span class="excluded-label">EXCLUDED</span>
                }
              </div>

              <div class="category-actions">
                @if (isCategoryExcluded()) {
                  <button
                    mat-stroked-button
                    color="primary"
                    (click)="onIncludeCategory()"
                    class="action-button include-button"
                    matTooltip="Include category in calculations">
                    <mat-icon>add_circle</mat-icon>
                    Include Category
                  </button>
                } @else {
                  <button
                    mat-stroked-button
                    color="warn"
                    (click)="onExcludeCategory()"
                    class="action-button exclude-button"
                    matTooltip="Exclude category from calculations">
                    <mat-icon>remove_circle</mat-icon>
                    Exclude Category
                  </button>
                }
              </div>
            </div>

            @if (isCategoryExcluded()) {
              <p class="bulk-update-description">
                This category is currently excluded from all percentage calculations. Click "Include Category" to include it in calculations.
              </p>
            } @else {
              <p class="bulk-update-description">
                Exclude this entire category from percentage calculations. This will affect all lines in the category.
              </p>
            }
            </mat-card-content>
          }
        </mat-card>

        <mat-divider class="section-divider"></mat-divider>
      }

      <!-- Lines Table -->
      <div class="table-container">
        @if (groupBySubCategory()) {
          <!-- Grouped by Sub-category -->
          @for (group of getGroupKeys(); track group) {
            <div class="sub-category-group">
              <div class="sub-category-header" [class.excluded]="getSubCategoryIdFromGroupName(group) && isSubCategoryExcluded(getSubCategoryIdFromGroupName(group)!)">
                <div class="left-section">
                  <mat-icon>folder</mat-icon>
                  <h3>{{ group }}</h3>
                  <!-- Status icon for sub-category mapping completeness -->
                  <mat-icon 
                    class="mapping-status-icon sub-category-status"
                    [class.complete]="getSubCategoryAllLinesHaveCompleteMappings(group)"
                    [class.incomplete]="!getSubCategoryAllLinesHaveCompleteMappings(group)"
                    [title]="getSubCategoryAllLinesHaveCompleteMappings(group) ? 'All lines in ' + group + ' have complete table and column mappings' : 'Some lines in ' + group + ' are missing table or column mappings'">
                    {{ getSubCategoryAllLinesHaveCompleteMappings(group) ? 'check_circle' : 'warning' }}
                  </mat-icon>
                  @if (getSubCategoryIdFromGroupName(group) && isSubCategoryExcluded(getSubCategoryIdFromGroupName(group)!)) {
                    <span class="excluded-label">EXCLUDED</span>
                  }
                </div>
                <div class="right-section">
                  <span class="line-count">{{ groupedLines()[group].length }} line(s)</span>
                  
                  <!-- Exclude/Include Actions -->
                  @if (getSubCategoryIdFromGroupName(group)) {
                    <div class="sub-category-actions">
                      @if (areAllLinesInSubCategoryExcluded(group)) {
                        <button
                          mat-stroked-button
                          color="primary"
                          (click)="onIncludeAllLinesInSubCategory(getSubCategoryIdFromGroupName(group)!, group)"
                          class="action-button include-button"
                          matTooltip="Include all lines in this sub-category">
                          <mat-icon>add_circle</mat-icon>
                          Include All Lines
                        </button>
                      } @else if (isSubCategoryExcluded(getSubCategoryIdFromGroupName(group)!) && !areAllLinesInSubCategoryExcluded(group)) {
                        <button
                          mat-stroked-button
                          color="primary"
                          (click)="onIncludeSubCategory(getSubCategoryIdFromGroupName(group)!, group)"
                          class="action-button include-button"
                          matTooltip="Include sub-category in calculations">
                          <mat-icon>add_circle</mat-icon>
                          Include Sub-category
                        </button>
                      } @else {
                        <button
                          mat-stroked-button
                          color="warn"
                          (click)="onExcludeSubCategory(getSubCategoryIdFromGroupName(group)!, group)"
                          class="action-button exclude-button"
                          matTooltip="Exclude sub-category from calculations">
                          <mat-icon>remove_circle</mat-icon>
                          Exclude
                        </button>
                      }
                    </div>
                  }
                  
                  <!-- Add Comment button in header -->
                  @if (!getSubCategoryComment(group) && !getSubCategoryEditingComment(group)) {
                    <button
                      mat-stroked-button
                      (click)="startEditingSubCategoryComment(group)"
                      class="add-comment-button-header">
                      <mat-icon>add_comment</mat-icon>
                      Add Comment
                    </button>
                  }
                  <button
                    mat-icon-button
                    (click)="toggleSubCategoryBulkCommands(group)"
                    [class.expanded]="getSubCategoryBulkCommandsVisible(group)"
                    [class.has-bulk-commands]="hasSubCategoryBulkCommands(group)"
                    class="bulk-commands-toggle"
                    [attr.aria-label]="getSubCategoryBulkCommandsVisible(group) ? 'Hide bulk commands' : 'Show bulk commands'">
                    <mat-icon>{{ getSubCategoryBulkCommandsVisible(group) ? 'expand_less' : 'expand_more' }}</mat-icon>
                  </button>
                </div>
              </div>

              <!-- Sub-category Comment Section -->
              @if (getSubCategoryComment(group) || getSubCategoryEditingComment(group)) {
                <div class="sub-category-comment-section">
                  @if (getSubCategoryEditingComment(group)) {
                    <!-- Editing mode -->
                    <div class="comment-editing">
                      <mat-form-field appearance="outline" class="comment-textarea">
                        <mat-label>Add a comment for {{ group }}</mat-label>
                        <textarea
                          matInput
                          [ngModel]="getSubCategoryCommentText(group)"
                          (ngModelChange)="subCategoryCommentText.set(group, $event)"
                          placeholder="Enter your comment here..."
                          rows="3"
                          [disabled]="getSubCategorySavingComment(group)">
                        </textarea>
                      </mat-form-field>
                      <div class="comment-actions">
                        <button
                          mat-button
                          (click)="cancelEditingSubCategoryComment(group)"
                          [disabled]="getSubCategorySavingComment(group)">
                          Cancel
                        </button>
                        <button
                          mat-raised-button
                          color="primary"
                          (click)="saveSubCategoryComment(group)"
                          [disabled]="getSubCategorySavingComment(group)">
                          @if (getSubCategorySavingComment(group)) {
                            <mat-spinner diameter="20"></mat-spinner>
                            Saving...
                          } @else {
                            Save Comment
                          }
                        </button>
                      </div>
                    </div>
                  } @else {
                    <!-- Display mode -->
                    <div class="comment-display">
                      <div class="comment-content">
                        <mat-icon class="comment-icon">comment</mat-icon>
                        <div class="comment-text">{{ getSubCategoryComment(group) }}</div>
                      </div>
                      <button
                        mat-icon-button
                        (click)="startEditingSubCategoryComment(group)"
                        class="edit-comment-button"
                        [attr.aria-label]="'Edit comment for ' + group">
                        <mat-icon>edit</mat-icon>
                      </button>
                    </div>
                  }
                </div>
              }

              <!-- Sub-category Bulk Update Section -->
              @if ((getSubCategoryLinesWithoutTable(group).length > 0 || getSubCategoryLinesWithoutColumn(group).length > 0 || getSubCategoryLinesWithTable(group).length > 0 || getSubCategoryLinesWithColumn(group).length > 0) && getSubCategoryBulkCommandsVisible(group)) {
                <mat-card class="sub-category-bulk-update-card">
                  <mat-card-header>
                    <mat-card-title>
                      <mat-icon>batch_prediction</mat-icon>
                      Bulk Update Commands for {{ group }}
                    </mat-card-title>
                    <mat-card-subtitle>
                      @if (getSubCategoryLinesWithoutTable(group).length > 0 && getSubCategoryLinesWithoutColumn(group).length > 0) {
                        {{ getSubCategoryLinesWithoutTable(group).length }} line(s) without table, {{ getSubCategoryLinesWithoutColumn(group).length }} line(s) without column
                      } @else if (getSubCategoryLinesWithoutTable(group).length > 0) {
                        {{ getSubCategoryLinesWithoutTable(group).length }} line(s) without table assignment
                      } @else if (getSubCategoryLinesWithoutColumn(group).length > 0) {
                        {{ getSubCategoryLinesWithoutColumn(group).length }} line(s) without column assignment
                      } @else if (getSubCategoryLinesWithTable(group).length > 0 || getSubCategoryLinesWithColumn(group).length > 0) {
                        {{ getSubCategoryLinesWithTable(group).length }} line(s) with table, {{ getSubCategoryLinesWithColumn(group).length }} line(s) with column
                      }
                    </mat-card-subtitle>
                  </mat-card-header>
                  <mat-card-content>
                    <form [formGroup]="getSubCategoryBulkUpdateForm(group)" class="bulk-update-form">
                      <div class="bulk-update-controls">
                        <mat-form-field appearance="outline" class="table-selector">
                          <mat-label>Select Table</mat-label>
                          <input
                            matInput
                            formControlName="table_name"
                            [matAutocomplete]="subCategoryTableAuto"
                            placeholder="Type to search tables..."
                            (focus)="onSubCategoryTableInputFocus(group)"
                            (blur)="onSubCategoryTableInputBlur(group)"
                            (input)="onSubCategoryTableInputChange(group)">
                          <mat-autocomplete
                            #subCategoryTableAuto="matAutocomplete"
                            [displayWith]="displayTableName"
                            (optionSelected)="onSubCategoryTableSelected(group, $event.option.value)"
                            class="compact-autocomplete"
                            [class.hide-dropdown]="!getSubCategoryTableDropdownOpen(group)">
                            @if (getSubCategoryTableDropdownOpen(group)) {
                              @for (table of getSubCategoryFilteredTables$(group) | async; track table.id) {
                                <mat-option [value]="table" class="compact-option">
                                  {{ table.name }} - {{ table.description }}
                                </mat-option>
                              }
                            }
                          </mat-autocomplete>
                        </mat-form-field>

                        <button
                          mat-stroked-button
                          type="button"
                          (click)="onSuggestTablesForSubCategory(group)"
                          [disabled]="getSubCategoryLoadingSuggestedTables(group)"
                          class="suggest-tables-button">
                          @if (getSubCategoryLoadingSuggestedTables(group)) {
                            <mat-spinner diameter="20"></mat-spinner>
                            Finding matches...
                          } @else {
                            <ng-container>
                              <mat-icon>recommend</mat-icon>
                              Suggest Tables
                            </ng-container>
                          }
                        </button>

                        <button
                          mat-raised-button
                          color="primary"
                          [disabled]="!getSubCategorySelectedTableId(group) || getSubCategoryBulkUpdating(group)"
                          (click)="bulkUpdateTableForSubCategory(group)"
                          class="bulk-update-button">
                          @if (getSubCategoryBulkUpdating(group)) {
                            <mat-spinner diameter="20"></mat-spinner>
                            Updating {{ getSubCategoryBulkUpdateProgress(group).completed }}/{{ getSubCategoryBulkUpdateProgress(group).total }}...
                          } @else {
                            <ng-container>
                              <mat-icon>update</mat-icon>
                              Set Table for {{ group }}
                            </ng-container>
                          }
                        </button>
                      </div>
                    </form>

                    <!-- Sub-category Table Suggestions Results -->
                    @if (getSubCategoryShowSuggestedTables(group) && getSubCategorySuggestedTables(group).length > 0) {
                      <div class="table-suggestions-section">
                        <div class="suggestions-header">
                          <h4>Table Suggestions for {{ group }}</h4>
                          <button mat-icon-button (click)="closeSuggestedTablesForSubCategory(group)">
                            <mat-icon>close</mat-icon>
                          </button>
                        </div>
                        <div class="table-suggestions-list">
                          @for (match of getSubCategorySuggestedTables(group); track match.table_id) {
                            <div
                              class="table-suggestion-item"
                              (click)="onSelectSuggestedTableForSubCategory(group, match)">
                              <div class="suggestion-header">
                                <span class="table-name">{{ match.table_name }}</span>
                                <span class="match-count">{{ match.match_count }} of {{ match.total_columns }} matches</span>
                              </div>
                              <div class="matched-columns">
                                <span class="column-chip" *ngFor="let col of match.matched_columns.slice(0, 5)">
                                  {{ col }}
                                </span>
                                @if (match.matched_columns.length > 5) {
                                  <span class="more-columns">+{{ match.matched_columns.length - 5 }} more</span>
                                }
                              </div>
                            </div>
                          }
                        </div>
                      </div>
                    }
                    @if (getSubCategoryBulkUpdating(group)) {
                      <div class="bulk-update-progress">
                        <mat-progress-bar
                          mode="determinate"
                          [value]="(getSubCategoryBulkUpdateProgress(group).completed / getSubCategoryBulkUpdateProgress(group).total) * 100">
                        </mat-progress-bar>
                        <p class="progress-text">
                          Updated {{ getSubCategoryBulkUpdateProgress(group).completed }} of {{ getSubCategoryBulkUpdateProgress(group).total }} lines
                          @if (getSubCategoryBulkUpdateProgress(group).failed > 0) {
                            ({{ getSubCategoryBulkUpdateProgress(group).failed }} failed)
                          }
                        </p>
                      </div>
                    } @else {
                      <p class="bulk-update-description">
                        This will set the selected table for all {{ getSubCategoryLinesWithoutTable(group).length }} line(s) in {{ group }} that currently don't have a table assigned. Column names will remain unchanged.
                      </p>
                    }

                    <!-- Column Update Command for Sub-category -->
                    @if (getSubCategoryLinesWithoutColumn(group).length > 0) {
                      <mat-divider class="command-divider"></mat-divider>
                      <div class="bulk-update-controls">
                        <div class="command-info">
                          <mat-icon>view_column</mat-icon>
                          <span class="command-title">Update Columns by Field Name for {{ group }}</span>
                        </div>

                        <button
                          mat-raised-button
                          color="accent"
                          [disabled]="getSubCategoryBulkUpdatingColumns(group)"
                          (click)="bulkUpdateColumnsForSubCategory(group)"
                          class="bulk-update-button">
                          @if (getSubCategoryBulkUpdatingColumns(group)) {
                            <mat-spinner diameter="20"></mat-spinner>
                            Updating {{ getSubCategoryColumnBulkUpdateProgress(group).completed }}/{{ getSubCategoryColumnBulkUpdateProgress(group).total }}...
                          } @else {
                            <ng-container>
                              <mat-icon>auto_fix_high</mat-icon>
                              Match Columns for {{ group }}
                            </ng-container>
                          }
                        </button>
                      </div>

                      @if (getSubCategoryBulkUpdatingColumns(group)) {
                        <div class="bulk-update-progress">
                          <mat-progress-bar
                            mode="determinate"
                            [value]="(getSubCategoryColumnBulkUpdateProgress(group).completed / getSubCategoryColumnBulkUpdateProgress(group).total) * 100">
                          </mat-progress-bar>
                          <p class="progress-text">
                            Updated {{ getSubCategoryColumnBulkUpdateProgress(group).completed }} of {{ getSubCategoryColumnBulkUpdateProgress(group).total }} columns
                            @if (getSubCategoryColumnBulkUpdateProgress(group).failed > 0) {
                              ({{ getSubCategoryColumnBulkUpdateProgress(group).failed }} failed)
                            }
                          </p>
                        </div>
                      } @else {
                        <p class="bulk-update-description">
                          This will match field names to column names for all {{ getSubCategoryLinesWithoutColumn(group).length }} line(s) in {{ group }} that have a table but no column assigned.
                        </p>
                      }
                    }

                    <!-- Clear Table Names Command for Sub-category -->
                    @if (getSubCategoryLinesWithTable(group).length > 0) {
                      <mat-divider class="command-divider"></mat-divider>
                      <div class="bulk-update-controls">
                        <div class="command-info">
                          <mat-icon>clear_all</mat-icon>
                          <span class="command-title">Clear All Table Names for {{ group }}</span>
                        </div>

                        <button
                          mat-raised-button
                          color="warn"
                          [disabled]="getSubCategoryBulkClearingTables(group)"
                          (click)="bulkClearTableNamesForSubCategory(group)"
                          class="bulk-update-button">
                          @if (getSubCategoryBulkClearingTables(group)) {
                            <mat-spinner diameter="20"></mat-spinner>
                            Clearing {{ getSubCategoryTableClearProgress(group).completed }}/{{ getSubCategoryTableClearProgress(group).total }}...
                          } @else {
                            <ng-container>
                              <mat-icon>delete_sweep</mat-icon>
                              Clear Table Names for {{ group }}
                            </ng-container>
                          }
                        </button>
                      </div>

                      @if (getSubCategoryBulkClearingTables(group)) {
                        <div class="bulk-update-progress">
                          <mat-progress-bar
                            mode="determinate"
                            [value]="(getSubCategoryTableClearProgress(group).completed / getSubCategoryTableClearProgress(group).total) * 100">
                          </mat-progress-bar>
                          <p class="progress-text">
                            Cleared {{ getSubCategoryTableClearProgress(group).completed }} of {{ getSubCategoryTableClearProgress(group).total }} table names
                            @if (getSubCategoryTableClearProgress(group).failed > 0) {
                              ({{ getSubCategoryTableClearProgress(group).failed }} failed)
                            }
                          </p>
                        </div>
                      } @else {
                        <p class="bulk-update-description">
                          This will clear table assignments for all {{ getSubCategoryLinesWithTable(group).length }} line(s) in {{ group }} that currently have a table assigned.
                        </p>
                      }
                    }

                    <!-- Clear Column Names Command for Sub-category -->
                    @if (getSubCategoryLinesWithColumn(group).length > 0) {
                      <mat-divider class="command-divider"></mat-divider>
                      <div class="bulk-update-controls">
                        <div class="command-info">
                          <mat-icon>clear_all</mat-icon>
                          <span class="command-title">Clear All Column Names for {{ group }}</span>
                        </div>

                        <button
                          mat-raised-button
                          color="warn"
                          [disabled]="getSubCategoryBulkClearingColumns(group)"
                          (click)="bulkClearColumnNamesForSubCategory(group)"
                          class="bulk-update-button">
                          @if (getSubCategoryBulkClearingColumns(group)) {
                            <mat-spinner diameter="20"></mat-spinner>
                            Clearing {{ getSubCategoryColumnClearProgress(group).completed }}/{{ getSubCategoryColumnClearProgress(group).total }}...
                          } @else {
                            <ng-container>
                              <mat-icon>delete_sweep</mat-icon>
                              Clear Column Names for {{ group }}
                            </ng-container>
                          }
                        </button>
                      </div>

                      @if (getSubCategoryBulkClearingColumns(group)) {
                        <div class="bulk-update-progress">
                          <mat-progress-bar
                            mode="determinate"
                            [value]="(getSubCategoryColumnClearProgress(group).completed / getSubCategoryColumnClearProgress(group).total) * 100">
                          </mat-progress-bar>
                          <p class="progress-text">
                            Cleared {{ getSubCategoryColumnClearProgress(group).completed }} of {{ getSubCategoryColumnClearProgress(group).total }} column names
                            @if (getSubCategoryColumnClearProgress(group).failed > 0) {
                              ({{ getSubCategoryColumnClearProgress(group).failed }} failed)
                            }
                          </p>
                        </div>
                      } @else {
                        <p class="bulk-update-description">
                          This will clear column assignments for all {{ getSubCategoryLinesWithColumn(group).length }} line(s) in {{ group }} that currently have a column assigned.
                        </p>
                      }
                    }
                  </mat-card-content>
                </mat-card>

                <mat-divider class="section-divider"></mat-divider>
              }

              <table mat-table [dataSource]="groupedLines()[group]" class="lines-table">
                <!-- ID Column -->
                <ng-container matColumnDef="id">
                  <th mat-header-cell *matHeaderCellDef>ID</th>
                  <td mat-cell *matCellDef="let line">{{ line.id }}</td>
                </ng-container>

                <!-- Name Column -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>Name</th>
                  <td mat-cell *matCellDef="let line">{{ line.name || line.Name || '-' }}</td>
                </ng-container>

                <!-- Field Name Column -->
                <ng-container matColumnDef="field_name">
                  <th mat-header-cell *matHeaderCellDef>Field Name</th>
                  <td mat-cell *matCellDef="let line">{{ line.field_name || '-' }}</td>
                </ng-container>

                <!-- Key Field Column -->
                <ng-container matColumnDef="key_field">
                  <th mat-header-cell *matHeaderCellDef mat-tooltip="Key fields used for joining tables">ðŸ”‘</th>
                  <td mat-cell *matCellDef="let line">
                    <mat-icon *ngIf="line.iskeyfield" 
                              color="primary" 
                              mat-tooltip="Key field - indicates this field is part of the key used to join tables"
                              aria-label="Key field"
                              role="img">vpn_key</mat-icon>
                  </td>
                </ng-container>

                <!-- Table Name Column -->
                <ng-container matColumnDef="table_name">
                  <th mat-header-cell *matHeaderCellDef>Table Name</th>
                  <td mat-cell *matCellDef="let line">{{ line.table_name || '-' }}</td>
                </ng-container>

                <!-- Column Name Column -->
                <ng-container matColumnDef="column_name">
                  <th mat-header-cell *matHeaderCellDef>Column Name</th>
                  <td mat-cell *matCellDef="let line">{{ line.column_name || '-' }}</td>
                </ng-container>

                <!-- Default Value Column -->
                <ng-container matColumnDef="default">
                  <th mat-header-cell *matHeaderCellDef>Default</th>
                  <td mat-cell *matCellDef="let line">{{ line.default || '-' }}</td>
                </ng-container>

                <!-- Reason Column -->
                <ng-container matColumnDef="reason">
                  <th mat-header-cell *matHeaderCellDef>Reason</th>
                  <td mat-cell *matCellDef="let line">{{ line.reason || '-' }}</td>
                </ng-container>

                <!-- Comment Column -->
                <ng-container matColumnDef="comment">
                  <th mat-header-cell *matHeaderCellDef>Comment</th>
                  <td mat-cell *matCellDef="let line">{{ line.comment || '-' }}</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="openEditDialog(row)" [class]="getRowClasses(row)" [attr.data-line-id]="row.id"></tr>
              </table>
            </div>
          }
        } @else {
          <!-- Regular flat table -->
          <table mat-table [dataSource]="lines()" class="lines-table">
            <!-- ID Column -->
            <ng-container matColumnDef="id">
              <th mat-header-cell *matHeaderCellDef>ID</th>
              <td mat-cell *matCellDef="let line">{{ line.id }}</td>
            </ng-container>

            <!-- Name Column -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Name</th>
              <td mat-cell *matCellDef="let line">{{ line.name || line.Name || '-' }}</td>
            </ng-container>

            <!-- Field Name Column -->
            <ng-container matColumnDef="field_name">
              <th mat-header-cell *matHeaderCellDef>Field Name</th>
              <td mat-cell *matCellDef="let line">{{ line.field_name || '-' }}</td>
            </ng-container>

            <!-- Key Field Column -->
            <ng-container matColumnDef="key_field">
              <th mat-header-cell *matHeaderCellDef mat-tooltip="Key fields used for joining tables">ðŸ”‘</th>
              <td mat-cell *matCellDef="let line">
                <mat-icon *ngIf="line.iskeyfield" 
                          color="primary" 
                          mat-tooltip="Key field - indicates this field is part of the key used to join tables"
                          aria-label="Key field"
                          role="img">vpn_key</mat-icon>


              </td>
            </ng-container>

            <!-- Table Name Column -->
            <ng-container matColumnDef="table_name">
              <th mat-header-cell *matHeaderCellDef>Table Name</th>
              <td mat-cell *matCellDef="let line">{{ line.table_name || '-' }}</td>
            </ng-container>

            <!-- Column Name Column -->
            <ng-container matColumnDef="column_name">
              <th mat-header-cell *matHeaderCellDef>Column Name</th>
              <td mat-cell *matCellDef="let line">{{ line.column_name || '-' }}</td>
            </ng-container>

            <!-- Default Value Column -->
            <ng-container matColumnDef="default">
              <th mat-header-cell *matHeaderCellDef>Default</th>
              <td mat-cell *matCellDef="let line">{{ line.default || '-' }}</td>
            </ng-container>

            <!-- Reason Column -->
            <ng-container matColumnDef="reason">
              <th mat-header-cell *matHeaderCellDef>Reason</th>
              <td mat-cell *matCellDef="let line">{{ line.reason || '-' }}</td>
            </ng-container>

            <!-- Comment Column -->
            <ng-container matColumnDef="comment">
              <th mat-header-cell *matHeaderCellDef>Comment</th>
              <td mat-cell *matCellDef="let line">{{ line.comment || '-' }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" (click)="openEditDialog(row)" [class]="getRowClasses(row)" [attr.data-line-id]="row.id"></tr>
          </table>
        }
      </div>
    }
  </div>
</div>


