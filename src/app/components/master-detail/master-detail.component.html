<div class="master-detail-container">
  <!-- Categories Sidebar (Master) -->
  <div class="categories-sidebar">
    <div class="sidebar-header">
      <h2>Categories</h2>
      <div class="header-actions">
        <button
          mat-icon-button
          (click)="navigateToHome()"
          [class.active]="!selectedCategory()"
          aria-label="Go to home"
          matTooltip="Go to home">
          <mat-icon>home</mat-icon>
        </button>
        <button
          mat-icon-button
          (click)="refreshCategories()"
          [disabled]="categoriesLoading()"
          aria-label="Refresh categories"
          matTooltip="Refresh categories">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
    </div>

    <!-- Search Filter -->
    <div class="filter-section">
      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Search categories...</mat-label>
        <input
          matInput
          type="text"
          [value]="filterText()"
          (input)="onFilterChange($event)"
          placeholder="Type to filter categories">
        <mat-icon matSuffix>search</mat-icon>
        @if (filterText()) {
          <button
            mat-icon-button
            matSuffix
            (click)="clearFilter()"
            aria-label="Clear search"
            matTooltip="Clear search">
            <mat-icon>clear</mat-icon>
          </button>
        }
      </mat-form-field>

      <!-- Epic Filter Toggle and Selection -->
      <div class="epic-filter-section">
        <button
          mat-stroked-button
          (click)="toggleEpicFilter()"
          [class.active]="epicFilterVisible()"
          class="epic-filter-toggle">
          <mat-icon>filter_list</mat-icon>
          Filter by Epic
        </button>

        @if (epicFilterVisible()) {
          <mat-form-field appearance="outline" class="epic-filter-field">
            <mat-label>Select Epic</mat-label>
            <mat-select
              [value]="selectedEpic()"
              (selectionChange)="onEpicChange($event.value)"
              placeholder="All Epics">
              <mat-option [value]="null">All Epics</mat-option>
              @for (epic of availableEpics(); track epic) {
                <mat-option [value]="epic">{{ epic }}</mat-option>
              }
            </mat-select>
            @if (selectedEpic()) {
              <button
                mat-icon-button
                matSuffix
                (click)="clearEpicFilter()"
                aria-label="Clear epic filter"
                matTooltip="Clear epic filter">
                <mat-icon>clear</mat-icon>
              </button>
            }
          </mat-form-field>
        }
      </div>

      @if ((filterText() || selectedEpic()) && filteredCategoriesCount() > 0) {
        <div class="filter-results-count">
          {{ filteredCategoriesCount() }} {{ filteredCategoriesCount() === 1 ? 'category' : 'categories' }} found
        </div>
      }
    </div>

    <div class="sidebar-content">
      @if (categoriesLoading()) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Loading categories...</p>
        </div>
      } @else if (categoriesError()) {
        <div class="error-container">
          <mat-icon color="warn">error</mat-icon>
          <p>{{ categoriesError() }}</p>
          <button mat-raised-button color="primary" (click)="refreshCategories()">
            Try Again
          </button>
        </div>
      } @else if (categories().length === 0) {
        <div class="empty-container">
          <mat-icon>folder_open</mat-icon>
          <p>No categories found</p>
        </div>
      } @else if (categoriesByTab().length === 0) {
        <div class="empty-container">
          <mat-icon>search_off</mat-icon>
          <p>No categories match your search</p>
          <button mat-raised-button color="primary" (click)="clearAllFilters()">
            Clear All Filters
          </button>
        </div>
      } @else {
        <mat-accordion class="categories-accordion" multi="true">
          @for (tabGroup of categoriesByTab(); track tabGroup.tabName) {
            <mat-expansion-panel
              class="tab-panel"
              [class.fully-mapped]="isTabFullyMapped(tabGroup.categories)"
              [class.has-selected]="tabContainsSelectedCategory(tabGroup.categories)"
              [expanded]="tabContainsSelectedCategory(tabGroup.categories)">

              <mat-expansion-panel-header class="tab-header">
                <!-- Progress bar background for tab -->
                <div
                  class="tab-progress-background"
                  [style.width.%]="getTabProgress(tabGroup.categories)">
                </div>

                <mat-panel-title class="tab-title">
                  <div class="tab-name-section">
                    <mat-icon class="tab-icon">folder</mat-icon>
                    <div class="tab-name-container">
                      <div class="tab-name-label">
                      <span class="tab-name">{{ tabGroup.tabName }}</span>
                      <span class="tab-count">({{ tabGroup.categories.length }})</span>
                    </div>
                      @if (getTabEpic(tabGroup.categories)) {
                        <span class="tab-epic-label">{{ getTabEpic(tabGroup.categories) }}</span>
                      }
                    </div>
                  </div>
                  <div class="tab-progress-section">
                    <div class="tab-progress-badge">
                      {{ getTabProgress(tabGroup.categories) }}%
                    </div>
                    @if (isTabFullyMapped(tabGroup.categories)) {
                      <mat-icon class="tab-check-icon">check_circle</mat-icon>
                    }
                  </div>
                </mat-panel-title>
              </mat-expansion-panel-header>

              <div class="categories-list">
                @for (category of tabGroup.categories; track category.id) {
                  <mat-card
                    class="category-item"
                    [class.selected]="selectedCategory()?.id === category.id"
                    [class.fully-mapped]="category.percent_mapped === 100"
                    [class.excluded]="isCategoryExcluded(category)"
                    (click)="selectCategory(category)">

                    <!-- Progress bar background -->
                    <div
                      class="progress-background"
                      [style.width.%]="category.percent_mapped || 0">
                    </div>

                    <mat-card-content>
                      <div class="category-header">
                        <div class="category-name-section">
                          <h3>{{ category.Name }}</h3>
                          @if (category.epic) {
                            <span class="epic-label">{{ category.epic }}</span>
                          }
                          @if (isCategoryExcluded(category)) {
                            <span class="excluded-label">EXCLUDED</span>
                          }
                        </div>
                        <div class="category-badges">
                          @if (category.percent_mapped !== undefined) {
                            <div class="percentage-badge">
                              {{ roundPercentage(category.percent_mapped) }}%
                            </div>
                          }
                          @if (category.percent_mapped === 100) {
                            <mat-icon class="check-icon">check_circle</mat-icon>
                          }
                        </div>
                      </div>
                      @if (category.description) {
                        <p class="category-description">{{ category.description }}</p>
                      }
                    </mat-card-content>
                  </mat-card>
                }
              </div>
            </mat-expansion-panel>
          }
        </mat-accordion>
      }
    </div>
  </div>

  <!-- Lines Content (Detail) -->
  <div class="lines-content">
    @if (!selectedCategory()) {
      <div class="no-selection">
        <mat-icon>table_chart</mat-icon>
        <h3>No Category Selected</h3>
        <p>Select a category from the left sidebar to view its lines</p>
      </div>
    } @else {
      <app-lines
        [categoryId]="selectedCategory()!.id"
        [categoryName]="selectedCategory()!.Name"
        [showToolbar]="false">
      </app-lines>
    }
  </div>
</div>

